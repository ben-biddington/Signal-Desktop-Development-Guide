# How encryption works (safeStorage)

`Signal-Desktop` uses an encrypted database to store conversations and messages locally.

Database encryption is set using the `key` pragma:

```ts
// src/adapters/signal/sqlite/query.ts
export const query = <T>(
  opts: SignalDatabaseOptions,
  fn: (db: SQL.Database) => T
) => {
  const db = SQL(opts.databaseFilePath, { readonly: true });

  try {
    //
    // [!] decrypt the database using a key
    //
    // See: Signal-Desktop/ts/sql/Server.ts, keyDatabase function
    // See: https://www.zetetic.net/sqlcipher/sqlcipher-api/#key
    db.pragma(`key = "x'${getDecryptionKey(opts.decryptionKeyFilePath)}'"`);

    return fn(db);
  } finally {
    db.close();
  }
};
```

## Database encryption key

The key used to encrypt the database is itself encrypted and saved as `~/.config/Signal-test/config.json`.

Encryption for `config.json` is provided by [`safeStorage`](https://www.electronjs.org/docs/latest/api/safe-storage), which means the encryption key for the database is **only** available to a running `electron` process.

Earlier versions of `Signal-Desktop` maintained the encryption key in plain text. This behaviour is still available if you use the `--password-store=basic` command line option for `electron`.

So `config.json` may contain either an unencrypted `key` field:

```json
{
  "key": "8694fee8d92212c02d18fdc3ea40e2f3fb8311f8abb890462468238d923b858a"
}
```

or an encrypted `encryptedKey` field:

```json
{
  "encryptedKey": "763131a0d0540f5c320a469422ca196e40f0ecf073532919258096cc28b6d424ed9b1937dc267ed04f8d5bf28d5210150cdc40a5c2584ac93bf6ba7c0aa9a7579e25fc6f01b3055c9808ad69d4a45fb5569813"
}
```

These have been generated by `getSQLKey` in `app/main.ts`.

## Encryption with `safeStorage`

You can see this being used in `getSQLKey`, it calls `safeStorage.decryptString` and `safeStorage.encryptString`:

```ts
// app/main.ts
function getSQLKey(): string {
  let update = false;
  const legacyKeyValue = userConfig.get("key");
  const modernKeyValue = userConfig.get("encryptedKey");

  const isEncryptionAvailable =
    safeStorage.isEncryptionAvailable() &&
    (!OS.isLinux() || safeStorage.getSelectedStorageBackend() !== "basic_text");

  let key: string;
  if (typeof modernKeyValue === "string") {
    if (!isEncryptionAvailable) {
      throw new Error("Can't decrypt database key");
    }

    getLogger().info("getSQLKey: decrypting key");
    const encrypted = Buffer.from(modernKeyValue, "hex");
    key = safeStorage.decryptString(encrypted);

    if (legacyKeyValue != null) {
      getLogger().info("getSQLKey: removing legacy key");
      userConfig.set("key", undefined);
    }
  } else if (typeof legacyKeyValue === "string") {
    key = legacyKeyValue;
    update = isEncryptionAvailable;
    if (update) {
      getLogger().info("getSQLKey: migrating key");
    } else {
      getLogger().info("getSQLKey: using legacy key");
    }
  } else {
    getLogger().warn("getSQLKey: got key from config, but it wasn't a string");
    key = generateSQLKey();
    update = true;
  }

  if (!update) {
    return key;
  }

  if (isEncryptionAvailable) {
    getLogger().info("getSQLKey: updating encrypted key in the config");
    const encrypted = safeStorage.encryptString(key).toString("hex");
    userConfig.set("encryptedKey", encrypted);
    userConfig.set("key", undefined);
  } else {
    getLogger().info("getSQLKey: updating plaintext key in the config");
    userConfig.set("key", key);
  }

  return key;
}
```

## Opting out of `safeStorage`

Encryption may be turned off by supplying the `--password-store=basic` command line argument to electron, for example:

```shell
# ps -efw | grep electron
/home/ben/sauce/Signal-Desktop/node_modules/.bin/electron --inspect=0 --remote-debugging-port=0 --password-store=basic /home/ben/sauce/Signal-Desktop/ci.js
```

Note that [the documentation suggests using quotes](https://www.electronjs.org/docs/latest/api/safe-storage)(`--password-store="basic"`), but that did not work for me.

You can see this being checked with `safeStorage.getSelectedStorageBackend` in `getSQLKey`:

```ts
// // app/main.ts
function getSQLKey(): string {
  // ...

  const isEncryptionAvailable =
    safeStorage.isEncryptionAvailable() &&
    (!OS.isLinux() || safeStorage.getSelectedStorageBackend() !== "basic_text");

  //...
}
```

## Reasons for opting out

### Allow tests to query database

This could be useful for finding conversations and messages during tests to make finding UI elements easier and more robust or injecting test data.
